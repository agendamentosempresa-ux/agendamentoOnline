import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import type {
  BaseScheduling,
  SchedulingType,
  SchedulingStatus,
  SchedulingData,
  CheckInStatus
} from '@/types/scheduling';

interface Scheduling extends BaseScheduling {
  data: SchedulingData;
}

interface SchedulingContextType {
  schedulings: Scheduling[];
  addScheduling: (scheduling: Omit<Scheduling, 'id' | 'createdAt' | 'status' | 'solicitanteId' | 'solicitanteEmail'>) => void;
  updateStatus: (id: string, status: SchedulingStatus, comment?: string) => void;
  updateCheckInStatus: (id: string, checkInStatus: 'autorizado' | 'negado' | 'nao-compareceu') => void;
  getSchedulingsByUser: (userId: string) => Scheduling[];
  getPendingSchedulings: () => Scheduling[];
  getApprovedSchedulings: () => Scheduling[];
}

const SchedulingContext = createContext<SchedulingContextType | undefined>(undefined);

export function SchedulingProvider({ children }: { children: ReactNode }) {
  const [schedulings, setSchedulings] = useState<Scheduling[]>([]);

  useEffect(() => {
    const stored = localStorage.getItem('petronas_schedulings');
    if (stored) {
      setSchedulings(JSON.parse(stored));
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('petronas_schedulings', JSON.stringify(schedulings));
  }, [schedulings]);

  const addScheduling = (scheduling: Omit<Scheduling, 'id' | 'createdAt' | 'status' | 'solicitanteId' | 'solicitanteEmail'>) => {
    const newScheduling: Scheduling = {
      ...scheduling,
      id: crypto.randomUUID(),
      status: 'pendente',
      solicitanteId: scheduling.requestedBy,
      solicitanteEmail: '',
      createdAt: new Date().toISOString(),
    };
    setSchedulings(prev => [...prev, newScheduling]);
  };

  const updateStatus = (id: string, status: SchedulingStatus, comment?: string) => {
    setSchedulings(prev =>
      prev.map(s =>
        s.id === id
          ? { ...s, status, observacoes: comment, reviewedAt: new Date().toISOString() }
          : s
      )
    );
  };

  const updateCheckInStatus = (id: string, checkInStatus: CheckInStatus) => {
    setSchedulings(prev =>
      prev.map(s =>
        s.id === id
          ? { ...s, checkInStatus, checkInAt: new Date().toISOString() }
          : s
      )
    );
  };

  const getSchedulingsByUser = (userId: string) => {
    return schedulings.filter(s => s.requestedBy === userId);
  };

  const getPendingSchedulings = () => {
    return schedulings.filter(s => s.status === 'pendente');
  };

  const getApprovedSchedulings = () => {
    return schedulings.filter(s => s.status === 'aprovado');
  };

  return (
    <SchedulingContext.Provider
      value={{
        schedulings,
        addScheduling,
        updateStatus,
        updateCheckInStatus,
        getSchedulingsByUser,
        getPendingSchedulings,
        getApprovedSchedulings,
      }}
    >
      {children}
    </SchedulingContext.Provider>
  );
}

export function useScheduling() {
  const context = useContext(SchedulingContext);
  if (context === undefined) {
    throw new Error('useScheduling must be used within a SchedulingProvider');
  }
  return context;
}
